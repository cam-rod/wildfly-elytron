<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elytron: Using Custom Principals with Elytron</title>
    <script src="/wildfly-elytron/assets/javascript/highlight.pack.js" type="text/javascript"></script>

    <link rel="shortcut icon" type="image/png" href="/wildfly-elytron/favicon.ico">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <!-- We override the colours from this theme manually -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <link rel="stylesheet" href="/wildfly-elytron/assets/css/styles.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
    <script src="/wildfly-elytron/assets/javascript/hl.js" type="text/javascript"></script>
    <link rel="alternate" type="application/rss+xml"  href="/wildfly-elytron/feed.xml" title="WildFly Elytron">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135301155-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-135301155-1');
    </script>
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Using Custom Principals with Elytron | WildFly Elytron</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Using Custom Principals with Elytron" />
<meta name="author" content="Cameron Rodriguez" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Sometimes, you need to access additional information about an authenticated user. As an example, you may want to know when they logged in, or what information they have on file. Traditionally, this type of information needed to be stored using security realm attributes associated with an identity. Now in WildFly 28, it is possible to use a custom Principal instance instead." />
<meta property="og:description" content="Sometimes, you need to access additional information about an authenticated user. As an example, you may want to know when they logged in, or what information they have on file. Traditionally, this type of information needed to be stored using security realm attributes associated with an identity. Now in WildFly 28, it is possible to use a custom Principal instance instead." />
<link rel="canonical" href="https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/" />
<meta property="og:url" content="https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/" />
<meta property="og:site_name" content="WildFly Elytron" />
<meta property="og:image" content="https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-04-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg" />
<meta property="twitter:title" content="Using Custom Principals with Elytron" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Cameron Rodriguez"},"dateModified":"2023-04-25T00:00:00+00:00","datePublished":"2023-04-25T00:00:00+00:00","description":"Sometimes, you need to access additional information about an authenticated user. As an example, you may want to know when they logged in, or what information they have on file. Traditionally, this type of information needed to be stored using security realm attributes associated with an identity. Now in WildFly 28, it is possible to use a custom Principal instance instead.","headline":"Using Custom Principals with Elytron","image":"https://wildfly-security.github.io/wildfly-elytron/assets/images/wildfly-elytron-logo.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/"},"url":"https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/"}</script>
<!-- End Jekyll SEO tag -->

</head>
<body>


<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header mdl-layout__header--scroll">
        <div class="mdl-layout__header-row ">
            <!-- Title -->
            <span class="mdl-layout-title"><h3>Wild<strong>Fly</strong>  Elytron</h3></span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <nav class="mdl-navigation mdl-layout--large-screen-only">
                
                    
                    
                    
                         <a class="mdl-navigation__link highlight-button Contribute-menuitem" href="/wildfly-elytron/contribute/">Contribute</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Guides-menuitem" href="/wildfly-elytron/guides/">Guides</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
                    
                
                    
                    
                    
                         <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
                    
                
            </nav>
        </div>
    </header>
    <div class="mdl-layout__drawer">
        <div class="side-drawer-logo-container"><h3>Wild<strong>Fly</strong>  Elytron</h3></div>
        <nav class="mdl-navigation">
            
            
            
            
                <a class="mdl-navigation__link highlight-sidebar Contribute-menuitem" href="/wildfly-elytron/contribute/">Contribute</a>
            
            
            
            
            
                <a class="mdl-navigation__link Home-menuitem" href="/wildfly-elytron/">Home</a>
            
            
            
            
            
                <a class="mdl-navigation__link Guides-menuitem" href="/wildfly-elytron/guides/">Guides</a>
            
            
            
            
            
                <a class="mdl-navigation__link Docs-menuitem" href="/wildfly-elytron/docs/">Docs</a>
            
            
            
            
            
                <a class="mdl-navigation__link Community-menuitem" href="/wildfly-elytron/community/">Community</a>
            
            
            
            
            
                <a class="mdl-navigation__link mdl-navigation__link--current Blog-menuitem" href="/wildfly-elytron/blog/">Blog</a>
            
            
            
            
            
                <a class="mdl-navigation__link GitHub-menuitem" href="https://github.com/wildfly-security/wildfly-elytron">GitHub</a>
            
            
            <!-- mdl-navigation__link--current -->
        </nav>
    </div>
    <main class="mdl-layout__content">
        <div class="page-content">
            
            <div class="content">
                <div class="post-page grid-wrapper">
  <div class="grid__item width-12-12 width-12-12-m doc-content">
    <h1>Using Custom Principals with Elytron</h1>
    <div class="grid-wrapper">
      <div class="grid__item width-8-12 width-12-12-m byline-wrapper">
        
        
          <img class="headshot" src="https://www.gravatar.com/avatar/aba64bbfde66646d5b5bc40d23b7e0de">
        
        <p class="byline">
          By <a href="https://github.com/cam-rod">Cameron Rodriguez</a> | April 25, 2023
          <br>
          
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/custom-principal"> #custom-principal</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/principal"> #principal</a>
            
              <a style="font-size: 0.9em;" href="/wildfly-elytron/blog/tag/principal-transformer"> #principal-transformer</a>
            
          
        </p>
      </div>
      
      <div class="grid__item width-4-12 width-12-12-m"><div class="share-page">
  <a class="share-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/&title=Using Custom Principals with Elytron" rel="nofollow" target="_blank" title="Share on LinkedIn">
    <i class="fab fa-linkedin"></i>
  </a>
  <a class="share-twitter" href="https://twitter.com/intent/tweet?text=Using Custom Principals with Elytron&url=https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/&via=WildFlyAS&related=WildFlyAS" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="fab fa-twitter-square"></i>
  </a>
  <a class="share-facebook" href="https://facebook.com/sharer.php?u=https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="fab fa-facebook-square"></i>
  </a>
  <a class="share-reddit" href="http://www.reddit.com/submit?url=https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/" onclick="window.open(this.href, 'pop-up', 'left=20,top=20,width=900,height=500,toolbar=1,resizable=0'); return false;" title="Share on Reddit" >
    <i class="fab fa-reddit-square"></i>
  </a>
  <a class="share-email" href="mailto:?subject=Using Custom Principals with Elytron&amp;body=Using Custom Principals with Elytron https://wildfly-security.github.io/wildfly-elytron/blog/using-custom-principals-with-elytron/" title="Share via Email" >
    <i class="fas fa-envelope-square"></i>
  </a>
</div>
</div>
      <div class="grid__item width-12-12">
          <div class="paragraph">
<p>Sometimes, you need to access additional information about an
authenticated user. As an example, you may want to know when they logged
in, or what information they have on file. Traditionally, this type of
information needed to be stored using security realm attributes
associated with an identity. Now in WildFly 28, it is possible to use a
custom <code>Principal</code> instance instead.</p>
</div>
<div class="paragraph">
<p>Custom principals allow you to add fields and methods to a <code>Principal</code>. By
configuring a custom <code>PrincipalTransformer</code>, you can modify the principal
during the authentication process. You can then retrieve this principal,
and its functionality, from your application. Let&#8217;s take a look at how
this works.</p>
</div>
<div id="toc" class="toc">
<div id="toctitle" class="title"></div>
<ul class="sectlevel1">
<li><a href="#create-a-custom-principal">Create a custom principal</a></li>
<li><a href="#create-a-custom-principal-transformer">Create a custom principal transformer</a></li>
<li><a href="#configure-the-custom-components">Configure the custom components</a></li>
<li><a href="#accessing-the-custom-principal">Accessing the custom principal</a>
<ul class="sectlevel2">
<li><a href="#jakarta-security">Jakarta Security</a></li>
<li><a href="#using-securitycontext-with-elytron">Using SecurityContext with Elytron</a></li>
<li><a href="#jakarta-enterprise-beans-ejbs">Jakarta Enterprise Beans (EJBs)</a></li>
</ul>
</li>
<li><a href="#flexible-principals-for-real-time-functionality">Flexible principals for real-time functionality</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="create-a-custom-principal"><a class="anchor" href="#create-a-custom-principal"></a>Create a custom principal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, you&#8217;ll need to create a custom implementation of the Principal
class. The custom principal will be created at the pre-realm stage of
authentication, which you can learn more about in
<a href="https://darranl.blogspot.com/2017/07/wildfly-elytron-principal-transformers.html">this
blog post</a>.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create a class called <code>CustomPrincipal</code> that implements the
Principal class. This class will record the time a user logged in. We&#8217;ll
start with a basic definition of the class, introduce a <code>name</code> field, and
override <code>equals()</code> to compare against the name as well:</p>
</div>
<div class="listingblock">
<div class="title">A basic <code>Principal</code> implementation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.company.components;

import java.io.Serializable;
import java.security.Principal;
import java.time.LocalDateTime;

public class CustomPrincipal implements Principal, Serializable {
    private static final long serialVersionUID = 3384494813486178989L;
    private final String name;

    @Override
    public String getName() {
        return this.name;
    }

    @Override
    public boolean equals(final Object object) {
        if (object instanceof CustomPrincipal) {
            return this.name.equals( ((CustomPrincipal) object).getName() );
        }
        return false;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, let&#8217;s introduce a field to store the login time, a getter, and a
constructor to set the time:</p>
</div>
<div class="listingblock">
<div class="title">Adding login timestamps to the principal</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// [...]

public class CustomPrincipal implements Principal, Serializable {
    // [...]
    private final LocalDateTime loginTime;

    public CustomPrincipal(Principal principal, LocalDateTime loginTime) {
        this.name = principal.getName();
        this.loginTime = loginTime;
    }

    /** @return The time at which the user attempted authentication. */
    public LocalDateTime getloginTime() {
        return this.loginTime;
    }

    // [...]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s it! Our custom principal can now provide the time of login.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-a-custom-principal-transformer"><a class="anchor" href="#create-a-custom-principal-transformer"></a>Create a custom principal transformer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Elytron uses implementations of the <code>PrincipalTransformer</code> interface to
modify principals during the authentication. For example,
<code>regex-principal-transformer</code> will apply a regular expression to modify
the name of a principal. In the same way, we can use a
<code>custom-principal-transformer</code> to convert into our <code>CustomPrincipal</code>.</p>
</div>
<div class="paragraph">
<p>To do this, we&#8217;ll implement the <code>PrincipalTransformer</code> interface. In the
<code>apply()</code> method, we&#8217;ll record the current time and return a new instance of
our custom principal:</p>
</div>
<div class="listingblock">
<div class="title">A custom <code>PrincipalTransformer</code> implementation</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.company.components;

import java.security.Principal;
import java.time.LocalDateTime;

import org.wildfly.extension.elytron.capabilities.PrincipalTransformer;

public class CustomPrincipalTransformer implements PrincipalTransformer {

    @Override
    public Principal apply(Principal principal) {
        LocalDateTime loginTime = LocalDateTime.now();
        return new CustomPrincipal(principal, loginTime);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we needed to pass variables from the server configuration to the
transformer, we could also override the <code>initialize()</code> method. You can
learn more about custom components in the
<a href="https://docs.wildfly.org/28/WildFly_Elytron_Security.html#Custom_Components">Elytron
documentation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-the-custom-components"><a class="anchor" href="#configure-the-custom-components"></a>Configure the custom components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, we can configure WildFly to use our custom components. First,
package the custom principal and transformer into a JAR. Then, with
WildFly running, open the WildFly CLI in a terminal session, and add a
new module that contains our archive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] module add --name=custom-principal-components \
--resources=/PATH/TO/custom-principal-components.jar \
--dependencies=org.wildfly.security.elytron,org.wildfly.extension.elytron</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can configure a custom principal transformer that references this
new module. For example, let&#8217;s say we wanted to use our custom principal
with the <code>ApplicationDomain</code> security domain. We can add our transformer
as a <code>pre-realm-principal-transformer</code>. Here are the CLI commands needed
to achieve that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/custom-principal-transformer=customPrincipalTransformer:add(module=custom-principal-components,\
class-name=com.company.components.CustomPrincipalTransformer)
{"outcome" =&gt; "success"}

[standalone@localhost:9990 /] /subsystem=elytron/security-domain=ApplicationDomain:write-attribute(name=pre-realm-principal-transformer,\
value=customPrincipalTransformer)
{
    "outcome" =&gt; "success",
    "response-headers" =&gt; {
        "operation-requires-reload" =&gt; true,
        "process-state" =&gt; "reload-required"
    }
}

[standalone@localhost:9990 /] reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, whenever a user is authenticated via the <code>ApplicationDomain</code>, our
<code>CustomPrincipal</code> will be associated with that user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="accessing-the-custom-principal"><a class="anchor" href="#accessing-the-custom-principal"></a>Accessing the custom principal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are many ways you can retrieve a principal from within an
application. A few methods are listed below, with links to example
applications you can try yourself.</p>
</div>
<div class="sect2">
<h3 id="jakarta-security"><a class="anchor" href="#jakarta-security"></a>Jakarta Security</h3>
<div class="paragraph">
<p>With Jakarta Security, you can access the current user via the
<code>SecurityContext</code> object. Inject the <code>SecurityContext</code> into your Jakarta
Servlet, and use the standard methods <code>getCallerPrincipal()</code> or
<code>getPrincipalsByType()</code> to retrieve the custom principal:</p>
</div>
<div class="listingblock">
<div class="title">Accessing a custom principal with Jakarta Security</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.company.servlet;

// [...]

@WebServlet
public class MyServlet extends HttpServlet {

    @Inject
    private SecurityContext securityContext;

    private CustomPrincipal getCustomPrincipal() {
        Principal custPrincipal = securityContext.getCallerPrincipal();
        return (CustomPrincipal) custPrincipal;
    }

    private CustomPrincipal getCustomPrincipalByType() {
        Set&lt;CustomPrincipal&gt; principals = securityContext.getPrincipalsByType(CustomPrincipal.class);
        return principals.iterator().next();
    }

    // [...]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use this functionality, simply enable a default <em>Jakarta
Authorization (JACC)</em> policy in Elytron:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">[standalone@localhost:9990 /] /subsystem=elytron/policy=jacc:add(jacc-policy={})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/main/custom-principal-ee"><strong>custom-principal-ee</strong></a>
example is a full <em>Jakarta Security</em> implementation. It demonstrates how
both of these methods return the same class, making the custom principal
available to the Servlet.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-securitycontext-with-elytron"><a class="anchor" href="#using-securitycontext-with-elytron"></a>Using SecurityContext with Elytron</h3>
<div class="paragraph">
<p>When securing an application using an Elytron HTTP authentication
mechanism instead of Jakarta Security, it’s still possible to use the
<code>SecurityContext</code> to retrieve the custom principal from within an
application. By creating the default JACC policy and injecting a
<code>SecurityContext</code> into an application, WildFly will automatically allow
the application to use the interface to access the authorized identity.
The
<a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/main/custom-principal-ejb"><strong>custom-principal-elytron</strong></a>
example is similar to the
<a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/main/custom-principal-ee"><strong>custom-principal-ee</strong></a>
demo, but unlike the Jakarta Security application, it uses one of Elytron&#8217;s
built-in authentication mechanisms.</p>
</div>
</div>
<div class="sect2">
<h3 id="jakarta-enterprise-beans-ejbs"><a class="anchor" href="#jakarta-enterprise-beans-ejbs"></a>Jakarta Enterprise Beans (EJBs)</h3>
<div class="paragraph">
<p>The custom principal can be retrieved by any class implementing
<code>EJBContext</code>. For example, a stateless EJB can inject <code>SessionContext</code>, and
call <code>getCallerPrincipal()</code> to retrieve the custom principal:</p>
</div>
<div class="listingblock">
<div class="title">Accessing a custom principal from an EJB</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package com.company.beans;

// [...]

@Stateless
@Remote(MyBeanInterface.class)
public class MyBean implements MyBeanInterface {

    @Resource
    private SessionContext ejbContext;

    @Override
    public CustomPrincipal getCustomPrincipal() {
        Principal custPrincipal = ejbContext.getCallerPrincipal();
        return (CustomPrincipal) custPrincipal;
    }

    // [...]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/wildfly-security-incubator/elytron-examples/tree/main/custom-principal-ejb"><strong>custom-principal-ejb</strong></a>
example demonstrates a pair of EJBs and a remote client using methods
from a custom principal.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="flexible-principals-for-real-time-functionality"><a class="anchor" href="#flexible-principals-for-real-time-functionality"></a>Flexible principals for real-time functionality</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With WildFly 28, it’s now possible to associate a custom Principal class
with authenticated users. This means it’s now easier to access
additional information and methods for a user, without needing to store
it in a security realm or elsewhere.</p>
</div>
</div>
</div>
      </div>
    </div>
  </div>
</div>

            </div>
        </div>
    </main>
</div>
</body>
</html>
